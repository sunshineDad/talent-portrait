<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cgn.talent.core.mapper.PersonMaintenanceMapper">

    <resultMap id="BaseResultMap" type="com.cgn.talent.core.entity.PersonMaintenance">
        <id column="id" property="id"/>
        <result column="person_id" property="personId"/>
        <result column="talent_program" property="talentProgram"/>
        <result column="talent_plan" property="talentPlan"/>
        <result column="program_level" property="programLevel"/>
        <result column="selected_date" property="selectedDate"/>
        <result column="valid_start_date" property="validStartDate"/>
        <result column="valid_end_date" property="validEndDate"/>
        <result column="is_valid" property="isValid"/>
        <result column="certificate_no" property="certificateNo"/>
        <result column="support_measures" property="supportMeasures"/>
        <result column="training_plan" property="trainingPlan"/>
        <result column="assessment_requirements" property="assessmentRequirements"/>
        <result column="description" property="description"/>
        <result column="create_by" property="createBy"/>
        <result column="create_time" property="createTime"/>
        <result column="update_by" property="updateBy"/>
        <result column="update_time" property="updateTime"/>
        <result column="remark" property="remark"/>
    </resultMap>

    <!-- 根据人员ID查询人才信息维护记录 -->
    <select id="selectMaintenanceByPersonId" resultMap="BaseResultMap">
        SELECT
        pm.*,
        d1.dict_label as talent_program_name,
        d2.dict_label as talent_plan_name,
        d3.dict_label as program_level_name,
        CASE
        WHEN pm.valid_end_date >= NOW() THEN '在期'
        ELSE '过期'
        END as validity_status
        FROM t_talent_maintenance pm
        LEFT JOIN sys_dict_data d1 ON pm.talent_program = d1.dict_value AND d1.dict_type = 'TALENT_PROGRAM'
        LEFT JOIN sys_dict_data d2 ON pm.talent_plan = d2.dict_value AND d2.dict_type = 'TALENT_PLAN'
        LEFT JOIN sys_dict_data d3 ON pm.program_level = d3.dict_value AND d3.dict_type = 'PROGRAM_LEVEL'
        WHERE pm.person_id = #{personId}
        ORDER BY pm.selected_date DESC
    </select>

    <!-- 批量插入人才信息维护记录 -->
    <insert id="batchInsertMaintenance">
        INSERT INTO t_talent_maintenance (
        person_id, talent_program, talent_plan, program_level,
        selected_date, valid_start_date, valid_end_date, is_valid,
        certificate_no, support_measures, training_plan,
        assessment_requirements, description,
        create_by, create_time
        ) VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.personId}, #{item.talentProgram}, #{item.talentPlan}, #{item.programLevel},
            #{item.selectedDate}, #{item.validStartDate}, #{item.validEndDate}, #{item.isValid},
            #{item.certificateNo}, #{item.supportMeasures}, #{item.trainingPlan},
            #{item.assessmentRequirements}, #{item.description},
            #{item.createBy}, NOW())
        </foreach>
    </insert>

    <!-- 删除人员的所有人才信息维护记录 -->
    <delete id="deleteMaintenanceByPersonId">
        DELETE FROM t_talent_maintenance WHERE person_id = #{personId}
    </delete>

    <!-- 统计团队人才工程分布 -->
    <select id="selectTeamProgramDistribution" resultType="map">
        SELECT
        pm.talent_program,
        d1.dict_label as talent_program_name,
        pm.program_level,
        d2.dict_label as program_level_name,
        COUNT(DISTINCT pm.person_id) as person_count
        FROM t_talent_maintenance pm
        INNER JOIN person_info p ON pm.person_id = p.id
        LEFT JOIN sys_dict_data d1 ON pm.talent_program = d1.dict_value AND d1.dict_type = 'TALENT_PROGRAM'
        LEFT JOIN sys_dict_data d2 ON pm.program_level = d2.dict_value AND d2.dict_type = 'PROGRAM_LEVEL'
        WHERE p.del_flag = '0' AND p.status = '0' AND pm.is_valid = '1'
        <if test="teamId != null">
            AND p.team_id = #{teamId}
        </if>
        GROUP BY pm.talent_program, d1.dict_label, pm.program_level, d2.dict_label
        ORDER BY person_count DESC
    </select>
</mapper>
