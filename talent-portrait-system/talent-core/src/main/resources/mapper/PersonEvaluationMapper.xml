<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cgn.talent.core.mapper.PersonEvaluationMapper">

    <resultMap id="BaseResultMap" type="com.cgn.talent.core.entity.PersonEvaluation">
        <id column="id" property="id"/>
        <result column="person_id" property="personId"/>
        <result column="evaluation_year" property="evaluationYear"/>
        <result column="evaluation_dimension" property="evaluationDimension"/>
        <result column="dimension_score" property="dimensionScore"/>
        <result column="dimension_level" property="dimensionLevel"/>
        <result column="evaluation_content" property="evaluationContent"/>
        <result column="strengths" property="strengths"/>
        <result column="weaknesses" property="weaknesses"/>
        <result column="development_suggestions" property="developmentSuggestions"/>
        <result column="evaluator" property="evaluator"/>
        <result column="evaluation_date" property="evaluationDate"/>
        <result column="create_by" property="createBy"/>
        <result column="create_time" property="createTime"/>
        <result column="update_by" property="updateBy"/>
        <result column="update_time" property="updateTime"/>
        <result column="remark" property="remark"/>
    </resultMap>

    <!-- 根据人员ID查询评估记录 -->
    <select id="selectEvaluationByPersonId" resultMap="BaseResultMap">
        SELECT
        pe.*,
        d.dict_label as evaluation_dimension_name,
        (pe.dimension_score / 100) * 100 as score_percentage
        FROM person_evaluation pe
        LEFT JOIN sys_dict_data d ON pe.evaluation_dimension = d.dict_value AND d.dict_type = 'evaluation_dimension'
        WHERE pe.person_id = #{personId}
        ORDER BY pe.evaluation_year DESC, pe.evaluation_dimension
    </select>

    <!-- 查询人员评估雷达图数据 -->
    <select id="selectEvaluationRadarData" resultType="map">
        SELECT
        pe.evaluation_dimension,
        d.dict_label as dimension_name,
        pe.dimension_score,
        pe.dimension_level
        FROM person_evaluation pe
        LEFT JOIN sys_dict_data d ON pe.evaluation_dimension = d.dict_value AND d.dict_type = 'evaluation_dimension'
        WHERE pe.person_id = #{personId} AND pe.evaluation_year = #{year}
        ORDER BY d.sort_order
    </select>

    <!-- 统计团队人才评估情况 -->
    <select id="selectTeamEvaluationStatistics" resultType="map">
        SELECT
        pe.evaluation_dimension,
        d.dict_label as dimension_name,
        AVG(pe.dimension_score) as avg_score,
        COUNT(DISTINCT pe.person_id) as person_count
        FROM person_evaluation pe
        INNER JOIN person_info p ON pe.person_id = p.id
        LEFT JOIN sys_dict_data d ON pe.evaluation_dimension = d.dict_value AND d.dict_type = 'evaluation_dimension'
        WHERE p.del_flag = '0' AND p.status = '0' AND pe.evaluation_year = #{year}
        <if test="teamId != null">
            AND p.team_id = #{teamId}
        </if>
        GROUP BY pe.evaluation_dimension, d.dict_label
        ORDER BY d.sort_order
    </select>
</mapper>
