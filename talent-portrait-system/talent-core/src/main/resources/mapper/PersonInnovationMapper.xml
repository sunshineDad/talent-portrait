<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cgn.talent.core.mapper.PersonInnovationMapper">

    <resultMap id="BaseResultMap" type="com.cgn.talent.core.entity.PersonInnovation">
        <id column="id" property="id"/>
        <result column="person_id" property="personId"/>
        <result column="innovation_type" property="innovationType"/>
        <result column="innovation_name" property="innovationName"/>
        <result column="innovation_level" property="innovationLevel"/>
        <result column="complete_date" property="completeDate"/>
        <result column="patent_no" property="patentNo"/>
        <result column="authors" property="authors"/>
        <result column="author_order" property="authorOrder"/>
        <result column="publication" property="publication"/>
        <result column="innovation_status" property="innovationStatus"/>
        <result column="economic_benefit" property="economicBenefit"/>
        <result column="social_benefit" property="socialBenefit"/>
        <result column="description" property="description"/>
        <result column="attachment_url" property="attachmentUrl"/>
        <result column="create_by" property="createBy"/>
        <result column="create_time" property="createTime"/>
        <result column="update_by" property="updateBy"/>
        <result column="update_time" property="updateTime"/>
        <result column="remark" property="remark"/>
    </resultMap>

    <!-- 根据人员ID查询创新产出 -->
    <select id="selectInnovationByPersonId" resultMap="BaseResultMap">
        SELECT
        pi.*,
        d1.dict_label as innovation_type_name,
        d2.dict_label as innovation_level_name,
        d3.dict_label as innovation_status_name,
        YEAR(pi.complete_date) as year
        FROM person_innovation pi
        LEFT JOIN sys_dict_data d1 ON pi.innovation_type = d1.dict_value AND d1.dict_type = 'innovation_type'
        LEFT JOIN sys_dict_data d2 ON pi.innovation_level = d2.dict_value AND d2.dict_type = 'innovation_level'
        LEFT JOIN sys_dict_data d3 ON pi.innovation_status = d3.dict_value AND d3.dict_type = 'innovation_status'
        WHERE pi.person_id = #{personId}
        ORDER BY pi.complete_date DESC
    </select>

    <!-- 按年度统计创新产出 -->
    <select id="selectInnovationByYear" resultType="map">
        SELECT
        YEAR(complete_date) as year,
        innovation_type,
        COUNT(*) as count,
        SUM(economic_benefit) as total_benefit
        FROM person_innovation
        WHERE person_id = #{personId}
        GROUP BY YEAR(complete_date), innovation_type
        ORDER BY year DESC, innovation_type
    </select>

    <!-- 统计团队创新产出 -->
    <select id="selectTeamInnovationStatistics" resultType="map">
        SELECT
        pi.innovation_type,
        d.dict_label as innovation_type_name,
        COUNT(*) as total_count,
        COUNT(DISTINCT pi.person_id) as person_count,
        SUM(pi.economic_benefit) as total_benefit
        FROM person_innovation pi
        INNER JOIN person_info p ON pi.person_id = p.id
        LEFT JOIN sys_dict_data d ON pi.innovation_type = d.dict_value AND d.dict_type = 'innovation_type'
        WHERE p.del_flag = '0' AND p.status = '0'
        <if test="teamId != null">
            AND p.team_id = #{teamId}
        </if>
        <if test="year != null">
            AND YEAR(pi.complete_date) = #{year}
        </if>
        GROUP BY pi.innovation_type, d.dict_label
        ORDER BY total_count DESC
    </select>
</mapper>
