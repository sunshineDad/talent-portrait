<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cgn.talent.core.mapper.PersonPerformanceMapper">

    <resultMap id="BaseResultMap" type="com.cgn.talent.core.entity.PersonPerformance">
        <id column="id" property="id"/>
        <result column="person_id" property="personId"/>
        <result column="year" property="year"/>
        <result column="quarter" property="quarter"/>
        <result column="performance_score" property="performanceScore"/>
        <result column="performance_level" property="performanceLevel"/>
        <result column="kpi_completion" property="kpiCompletion"/>
        <result column="work_quality" property="workQuality"/>
        <result column="work_attitude" property="workAttitude"/>
        <result column="team_contribution" property="teamContribution"/>
        <result column="improvement_suggestions" property="improvementSuggestions"/>
        <result column="evaluator" property="evaluator"/>
        <result column="evaluation_date" property="evaluationDate"/>
        <result column="create_by" property="createBy"/>
        <result column="create_time" property="createTime"/>
        <result column="update_by" property="updateBy"/>
        <result column="update_time" property="updateTime"/>
        <result column="remark" property="remark"/>
    </resultMap>

    <!-- 根据人员ID查询绩效历史 -->
    <select id="selectPerformanceByPersonId" resultMap="BaseResultMap">
        SELECT
        pp.*,
        d.dict_label as performance_level_name,
        CONCAT(pp.year, '年', IFNULL(CONCAT('第', pp.quarter, '季度'), '')) as period_desc
        FROM person_performance pp
        LEFT JOIN sys_dict_data d ON pp.performance_level = d.dict_value AND d.dict_type = 'performance_level'
        WHERE pp.person_id = #{personId}
        ORDER BY pp.year DESC, pp.quarter DESC
    </select>

    <!-- 查询绩效趋势数据 -->
    <select id="selectPerformanceTrend" resultType="map">
        SELECT
        year,
        quarter,
        performance_score,
        performance_level,
        kpi_completion
        FROM person_performance
        WHERE person_id = #{personId}
        <if test="startYear != null">
            AND year >= #{startYear}
        </if>
        <if test="endYear != null">
            AND year &lt;= #{endYear}
        </if>
        ORDER BY year, quarter
    </select>

    <!-- 统计团队绩效分布 -->
    <select id="selectTeamPerformanceDistribution" resultType="map">
        SELECT
        pp.performance_level,
        d.dict_label as performance_level_name,
        COUNT(*) as person_count,
        AVG(pp.performance_score) as avg_score
        FROM person_performance pp
        INNER JOIN person_info p ON pp.person_id = p.id
        LEFT JOIN sys_dict_data d ON pp.performance_level = d.dict_value AND d.dict_type = 'performance_level'
        WHERE p.del_flag = '0' AND p.status = '0'
        AND pp.year = #{year}
        <if test="teamId != null">
            AND p.team_id = #{teamId}
        </if>
        GROUP BY pp.performance_level, d.dict_label
        ORDER BY pp.performance_level
    </select>
</mapper>
