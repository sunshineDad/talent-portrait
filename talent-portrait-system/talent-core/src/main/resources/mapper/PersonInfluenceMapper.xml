<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cgn.talent.core.mapper.PersonInfluenceMapper">

    <resultMap id="BaseResultMap" type="com.cgn.talent.core.entity.PersonInfluence">
        <id column="id" property="id"/>
        <result column="person_code" property="personCode"/>
        <result column="talent_plan" property="talentPlan"/>
        <result column="talent_engineer" property="talentEngineer"/>
        <result column="organization" property="organization"/>
        <result column="external_title" property="externalTitle"/>
        <result column="start_date" property="startDate"/>
        <result column="end_date" property="endDate"/>
        <result column="is_current" property="isCurrent"/>
        <result column="create_by" property="createBy"/>
        <result column="create_time" property="createTime"/>
        <result column="update_by" property="updateBy"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <!-- 根据人员编号查询影响力信息 -->
    <select id="selectInfluenceByPersonCode" resultMap="BaseResultMap">
        SELECT
        pi.*,
        CASE
        WHEN pi.is_current = '1' THEN '在任'
        ELSE '离任'
        END as status_name,
        CASE
        WHEN pi.end_date IS NULL THEN TIMESTAMPDIFF(YEAR, pi.start_date, NOW())
        ELSE TIMESTAMPDIFF(YEAR, pi.start_date, pi.end_date)
        END as duration_years
        FROM person_influence pi
        WHERE pi.person_code = #{personCode}
        ORDER BY pi.is_current DESC, pi.start_date DESC
    </select>

    <!-- 批量插入影响力信息 -->
    <insert id="batchInsertInfluence">
        INSERT INTO person_influence (
        person_code, talent_plan, talent_engineer, organization,
        external_title, start_date, end_date, is_current,
        create_by, create_time
        ) VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.personCode}, #{item.talentPlan}, #{item.talentEngineer}, #{item.organization},
            #{item.externalTitle}, #{item.startDate}, #{item.endDate}, #{item.isCurrent},
            #{item.createBy}, NOW())
        </foreach>
    </insert>

    <!-- 删除人员的所有影响力信息 -->
    <delete id="deleteInfluenceByPersonCode">
        DELETE FROM person_influence WHERE person_code = #{personCode}
    </delete>

    <!-- 查询当前在任的影响力信息 -->
    <select id="selectCurrentInfluenceByPersonCode" resultMap="BaseResultMap">
        SELECT * FROM person_influence
        WHERE person_code = #{personCode} AND is_current = '1'
        ORDER BY start_date DESC
    </select>

    <!-- 统计团队影响力分布 -->
    <select id="selectTeamInfluenceStatistics" resultType="map">
        SELECT
        pi.talent_plan,
        COUNT(DISTINCT pi.person_code) as person_count,
        COUNT(CASE WHEN pi.is_current = '1' THEN 1 END) as current_count,
        COUNT(CASE WHEN pi.is_current = '0' THEN 1 END) as history_count
        FROM person_influence pi
        INNER JOIN person_info p ON pi.person_code = p.person_code
        WHERE p.del_flag = '0' AND p.status = '0'
        <if test="teamCode != null and teamCode != ''">
            AND p.team_code = #{teamCode}
        </if>
        GROUP BY pi.talent_plan
        ORDER BY person_count DESC
    </select>

    <!-- 查询人才计划分布统计 -->
    <select id="selectTalentPlanDistribution" resultType="map">
        SELECT
        pi.talent_plan,
        pi.talent_engineer,
        COUNT(DISTINCT pi.person_code) as person_count,
        GROUP_CONCAT(DISTINCT p.person_name) as person_names
        FROM person_influence pi
        INNER JOIN person_info p ON pi.person_code = p.person_code
        WHERE p.del_flag = '0' AND p.status = '0' AND pi.is_current = '1'
        <if test="teamCode != null and teamCode != ''">
            AND p.team_code = #{teamCode}
        </if>
        GROUP BY pi.talent_plan, pi.talent_engineer
        ORDER BY pi.talent_plan, person_count DESC
    </select>

    <!-- 更新影响力在任状态 -->
    <update id="updateInfluenceCurrentStatus">
        UPDATE person_influence
        SET is_current = CASE
        WHEN end_date IS NULL OR end_date > NOW() THEN '1'
        ELSE '0'
        END
        WHERE 1=1
    </update>
</mapper>
