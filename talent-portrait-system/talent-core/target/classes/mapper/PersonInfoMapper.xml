<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cgn.talent.core.mapper.PersonInfoMapper">

    <resultMap id="BaseResultMap" type="com.cgn.talent.core.entity.PersonInfo">
        <id column="id" property="id"/>
        <result column="person_code" property="personCode"/>
        <result column="person_name" property="personName"/>
        <result column="gender" property="gender"/>
        <result column="birth_date" property="birthDate"/>
        <result column="id_card" property="idCard"/>
        <result column="phone" property="phone"/>
        <result column="email" property="email"/>
        <result column="education" property="education"/>
        <result column="degree" property="degree"/>
        <result column="graduate_school" property="graduateSchool"/>
        <result column="major" property="major"/>
        <result column="work_start_date" property="workStartDate"/>
        <result column="join_date" property="joinDate"/>
        <result column="job_title" property="jobTitle"/>
        <result column="job_level" property="jobLevel"/>
        <result column="position" property="position"/>
        <result column="team_id" property="teamId"/>
        <result column="work_location" property="workLocation"/>
        <result column="employment_type" property="employmentType"/>
        <result column="political_status" property="politicalStatus"/>
        <result column="photo_url" property="photoUrl"/>
        <result column="status" property="status"/>
        <result column="del_flag" property="delFlag"/>
        <result column="create_by" property="createBy"/>
        <result column="create_time" property="createTime"/>
        <result column="update_by" property="updateBy"/>
        <result column="update_time" property="updateTime"/>
        <result column="remark" property="remark"/>
    </resultMap>

    <!-- 分页查询人员列表 -->
    <select id="selectPersonPage" resultMap="BaseResultMap">
        SELECT
        p.*,
        t.team_name,
        TIMESTAMPDIFF(YEAR, p.birth_date, CURDATE()) as age,
        TIMESTAMPDIFF(YEAR, p.work_start_date, CURDATE()) as work_years,
        TIMESTAMPDIFF(YEAR, p.join_date, CURDATE()) as company_years
        FROM person_info p
        LEFT JOIN team_info t ON p.team_id = t.id
        WHERE p.del_flag = '0'
        <if test="person.personCode != null and person.personCode != ''">
            AND p.person_code LIKE CONCAT('%', #{person.personCode}, '%')
        </if>
        <if test="person.personName != null and person.personName != ''">
            AND p.person_name LIKE CONCAT('%', #{person.personName}, '%')
        </if>
        <if test="person.teamId != null">
            AND (p.team_id = #{person.teamId} OR t.ancestors LIKE CONCAT('%,', #{person.teamId}, ',%'))
        </if>
        <if test="person.education != null and person.education != ''">
            AND p.education = #{person.education}
        </if>
        <if test="person.jobTitle != null and person.jobTitle != ''">
            AND p.job_title = #{person.jobTitle}
        </if>
        <if test="person.jobLevel != null and person.jobLevel != ''">
            AND p.job_level = #{person.jobLevel}
        </if>
        <if test="person.status != null and person.status != ''">
            AND p.status = #{person.status}
        </if>
        ORDER BY p.create_time DESC
    </select>

    <!-- 查询人员详细信息 -->
    <select id="selectPersonDetailById" resultMap="BaseResultMap">
        SELECT
        p.*,
        t.team_name,
        TIMESTAMPDIFF(YEAR, p.birth_date, CURDATE()) as age,
        TIMESTAMPDIFF(YEAR, p.work_start_date, CURDATE()) as work_years,
        TIMESTAMPDIFF(YEAR, p.join_date, CURDATE()) as company_years
        FROM person_info p
        LEFT JOIN team_info t ON p.team_id = t.id
        WHERE p.id = #{personId} AND p.del_flag = '0'
    </select>

    <!-- 统计人员基础信息 -->
    <select id="selectPersonStatistics" resultType="map">
        SELECT
        COUNT(1) as total_count,
        SUM(CASE WHEN status = '0' THEN 1 ELSE 0 END) as active_count,
        SUM(CASE WHEN education IN ('doctor', 'master') THEN 1 ELSE 0 END) as high_education_count,
        SUM(CASE WHEN job_title IN ('senior_engineer', 'advanced_engineer') THEN 1 ELSE 0 END) as high_title_count,
        AVG(TIMESTAMPDIFF(YEAR, birth_date, CURDATE())) as avg_age,
        AVG(TIMESTAMPDIFF(YEAR, work_start_date, CURDATE())) as avg_work_years
        FROM person_info
        WHERE del_flag = '0'
        <if test="teamId != null">
            AND team_id IN (
            SELECT id FROM team_info
            WHERE id = #{teamId} OR ancestors LIKE CONCAT('%,', #{teamId}, ',%')
            )
        </if>
    </select>

    <!-- 校验人员编号唯一性 -->
    <select id="checkPersonCodeUnique" resultType="int">
        SELECT COUNT(1) FROM person_info
        WHERE person_code = #{personCode} AND del_flag = '0'
        <if test="personId != null">
            AND id != #{personId}
        </if>
    </select>

    <!-- 校验身份证号唯一性 -->
    <select id="checkIdCardUnique" resultType="int">
        SELECT COUNT(1) FROM person_info
        WHERE id_card = #{idCard} AND del_flag = '0'
        <if test="personId != null">
            AND id != #{personId}
        </if>
    </select>
</mapper>
