<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cgn.talent.system.mapper.TeamInfoMapper">

    <resultMap id="BaseResultMap" type="com.cgn.talent.system.entity.TeamInfo">
        <id column="id" property="id"/>
        <result column="parent_id" property="parentId"/>
        <result column="team_code" property="teamCode"/>
        <result column="team_name" property="teamName"/>
        <result column="team_type" property="teamType"/>
        <result column="leader_id" property="leaderId"/>
        <result column="ancestors" property="ancestors"/>
        <result column="order_num" property="orderNum"/>
        <result column="status" property="status"/>
        <result column="del_flag" property="delFlag"/>
        <result column="create_by" property="createBy"/>
        <result column="create_time" property="createTime"/>
        <result column="update_by" property="updateBy"/>
        <result column="update_time" property="updateTime"/>
        <result column="remark" property="remark"/>
    </resultMap>

    <!-- 查询团队树形结构 -->
    <select id="selectTeamTree" resultMap="BaseResultMap">
        SELECT
        t.*,
        p.person_name as leader_name,
        (SELECT COUNT(1) FROM person_info WHERE team_id = t.id AND del_flag = '0' AND status = '0') as member_count
        FROM team_info t
        LEFT JOIN person_info p ON t.leader_id = p.id
        WHERE t.del_flag = '0'
        <if test="teamName != null and teamName != ''">
            AND t.team_name LIKE CONCAT('%', #{teamName}, '%')
        </if>
        <if test="teamType != null and teamType != ''">
            AND t.team_type = #{teamType}
        </if>
        <if test="status != null and status != ''">
            AND t.status = #{status}
        </if>
        ORDER BY t.parent_id, t.order_num
    </select>

    <!-- 根据团队ID查询子团队数量 -->
    <select id="selectChildrenCountById" resultType="int">
        SELECT COUNT(1) FROM team_info
        WHERE parent_id = #{teamId} AND del_flag = '0'
    </select>

    <!-- 查询团队下的人员数量 -->
    <select id="selectTeamMemberCount" resultType="int">
        SELECT COUNT(1) FROM person_info
        WHERE team_id = #{teamId} AND del_flag = '0' AND status = '0'
    </select>

    <!-- 校验团队编码唯一性 -->
    <select id="checkTeamCodeUnique" resultType="int">
        SELECT COUNT(1) FROM team_info
        WHERE team_code = #{teamCode} AND del_flag = '0'
        <if test="teamId != null">
            AND id != #{teamId}
        </if>
    </select>
</mapper>
